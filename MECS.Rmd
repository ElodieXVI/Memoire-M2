---
title: "Statistiques sur les MECS"
author: "Élodie Lemaire"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: 
  html_document:
    toc: true
    theme: simplex
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE,fig.align = 'center')
setwd("/Users/elodielemaire/Dropbox/QESS2/M2 - Mémoire")
library(pacman)
p_load(tidyverse,knitr,questionr,readxl,survey,gtsummary, rstatix, magrittr, #Pour analyses et manipulation
       ggcharts, huxtable, #pour les tableaux
       GGally, extrafont) #pour les graphiques
theme_gtsummary_language("fr", decimal.mark = ",", big.mark = " ")
source("Code/Recodage.R")
source("Code/Fonctions.R")

mecs <- subset(sor, CATEG_rec == "MECS")
mna <- subset(mecs, MNA == "1")
```

## Statistiques générales : âge d'entrée, type de mesures, durée de placement
On a 15 777 enfants sortis en 2017 qui étaient avant leur sortie en MECS. Ils sont 37.1% à être des filles et 61.8% à être des garçons. Avec comme moyenne d'âge 15.3 ans, contre 14.1 ans pour l'ensemble des enfants sortis en 2017.

```{r}
sor %>% tbl_summary(include = c(dur_dpla, CATEG_rec),
                    by = CATEG_rec, 
                    statistic = list(all_continuous() ~ "Q1 : {p25}, Med : {median}, Moy : {mean}, Q3 : {p75}"),
                    missing = "no") %>% 
  modify_header(label = " ") %>% 
  bold_labels() %>% 
  modify_spanning_header(c("stat_1", "stat_2","stat_3", "stat_4") ~ "**Type d'établissement**") %>%
  as_hux_table() %>% 
  add_footnote("Source : ES-PE 2017.") %>%
  add_footnote("Champ : Sur les 30 412 enfants sortis au cours de 2017.") %>%
  set_number_format(NA) %>% 
  set_caption("Durée de placement (en mois) des enfants sortis en 2017 par type d'établissement") 
```
La durée moyenne de placement en mois la plus longue observée est celle des enfants sortis au cours de l'année 2017 de villages pour enfants qui est de 59 mois en moyenne. Les MECS ont la deuxième durée moyenne de placement derrière les villages pour enfant de 17 mois en moyenne. Sachant qu'ils sont 25% des enfants sortis de MECS en 2017 à y être restés moins de 4 mois et 25% à y restés plus de 23 mois.

```{r 3}
sor$mecs <- case_when(sor$CATEG_rec == "MECS" ~ "En mecs",
                      T ~ "Pas en mecs")

ggplot(sor, aes(x = mois_e, y = mecs)) + 
  ggdist::stat_halfeye(adjust = .5, width = .6, .width = 0, justification = -.2, point_colour = NA) + 
  geom_boxplot(width = .15, outlier.shape = NA) +
  coord_cartesian(xlim = c(1.2, NA), clip = "off") +
  stat_summary(fun=mean, geom="point", shape=20, size=3, color="red", fill="red") +
  scale_x_continuous(breaks = 0:324*12)+
  ggtitle("Âge d'entrée en MECS par rappot aux autres types d'établissements") +
  theme_bw()

t.test(sor$age_e ~ sor$mecs)
t.test(sor$mois_e ~ sor$mecs)
```

L'âge moyen d'entrée en MECS est plus élevé que les autres types d'établissements, du fait d'un nombre moins important d'enfant ayant moins de 4 ans à leur entrée en MECS. Ils sont néanmoins 25% à être placés en MECS et à avoir plus de 18 ans. 

```{r}
sor %>% tbl_summary(include = c(HEBE_rec1, mecs),
                    by = HEBE_rec1,
                    percent = "row") %>%   
  modify_header(label = " ") %>% 
  bold_labels() %>% 
  modify_spanning_header(c("stat_1", "stat_2","stat_3", "stat_4", "stat_5") ~ "**Type d'hébergements**") %>%
  as_hux_table() %>% 
  add_footnote("Source : ES-PE 2017.") %>%
  add_footnote("Champ : Sur les 30 412 enfants sortis au cours de 2017.") %>%
  set_number_format(NA) %>% 
  set_caption("Répartition entre les types d'hébergement des enfants en MECS vis-à-vis des autres")

```

On observe que les MECS bien que comme les autres types d'établissements ils placent en majorité dans des types d'hébergements collectifs à 67%, ils placent aussi beaucoup dans des hébergements autonomes à 16% contre 9,5% pour le reste et à domicile à 13% contre 1,7% pour le reste des types d'établissements. Les MECS proposent très peu de placement en assistants familiaux seulement 2,5% des enfants sortis en 2017 y était, contre 8,6% pour les autres types d'établissements.

```{r}
sor %>% tbl_summary(include = c(MES_rec, mecs),
                    by = MES_rec,
                    percent = "row") %>%   
  modify_header(label = " ") %>% 
  bold_labels() %>% 
  modify_spanning_header(c("stat_1", "stat_2","stat_3", "stat_4", "stat_5", "stat_6", "stat_7", "stat_8") ~ "**Type de mesures principales**") %>%
  as_hux_table() %>% 
  add_footnote("Source : ES-PE 2017.") %>%
  add_footnote("Champ : Sur les 30 412 enfants sortis au cours de 2017.") %>%
  set_number_format(NA) %>% 
  set_caption("Répartition des types de mesures principales des enfants en MECS vis-à-vis des autres")
```

En termes de mesure principales, les enfants sortis en 2017 de MECS ont à 55% une mesure judiciaire confiée, contre 45% pour le reste des établissements. Ils ont aussi concernés particulièrement contrairemetn aux autres enfants sortis en 2017 d'autres établissements par des mesures administratives jeunes majeurs à 14% contre seul 1,3% pour les autres. Ils sont moins concernés par les mesures touchant la responsabilité parentale seulement 6,2% d'entre eux, contre 16% pour les enfants sortis d'autres types d'établissements.

## L'accueil séquentiel en MECS

```{r}
## Recodage de enf$SEQ en enf$SEQ_rec
enf$SEQ_rec <- enf$SEQ %>%
  as.character() %>%
  fct_recode(
    "Hébergement complet" = "1",
    "Accueil séquentiel : hébergement et domicile" = "2",
    "Accueil diversifié : différentes structures" = "3")


enf %>% tbl_summary(include = c(SEQ_rec, CATEG_rec),
                    by = CATEG_rec,
                    percent = "row") %>%   
  modify_header(label = " ")%>%
  as_hux_table() %>% 
  add_footnote("Source : ES-PE 2017.") %>%
  add_footnote("Champ : Sur les 34 963 enfants présents au cours de 2017.") %>%
  set_number_format(NA) %>% 
  set_caption("Répartition des types de mesures principales des enfants en MECS vis-à-vis des autres")
```




## Entrée en MECS et sortir de MECS

```{r}
mecs %>%
  tbl_cross(row = "HEBE_rec3", col ="SRES_rec", 
            missing = "ifany",
            percent = "col",
            label = list(HEBE_rec3 ~ "Hébergement en MECS")) %>% 
  modify_header(label = " ") %>% 
  bold_labels() %>% 
  modify_spanning_header(c("stat_1", "stat_2","stat_3", "stat_4", "stat_5", "stat_6") ~ "**Hébergement à la sortie**") %>%
  as_hux_table() %>% 
  add_footnote("Source : ES-PE 2017.") %>%
  add_footnote("Champ : Sur les 15 777 enfants sortis de MECS au cours de 2017.") %>%
  set_number_format(NA) %>% 
  set_caption("Type d'hébergement à l'entrée en MECS et juste à la sortie") 
```

```{r}
mecs$ARES_rec_t <- add_n(mecs$ARES_rec)
mecs %>%
  tbl_summary(include = c("HEBE_rec3", "ARES_rec_t"), 
              by = HEBE_rec3,
              missing = "no",
              statistic = list(all_categorical() ~ "{p}% ({n})"),
              label = list(ARES_rec_t ~ "Hébergement avant l'entrée")) %>% 
  modify_header(label = " ") %>% 
  bold_labels() %>% 
  bold_levels() %>% 
  modify_spanning_header(c("stat_1", "stat_2","stat_3", "stat_4") ~ "**HEBE**") %>%
  as_hux_table() %>% 
  add_footnote("Source : ES-PE 2017.") %>%
  add_footnote("Champ : Sur les 30 412 enfants sortis de l'établissement d'observation au cours de 2017, données pondérées.") %>%
  set_number_format(NA) %>% 
  set_caption("Type d'hébergement avant l'entrée en MECS et une fois en MECS") 
```

```{r}
mecs %>%
  tbl_cross(row = "ARES_rec", col ="SRES_rec", 
            missing = "ifany",
            percent = "col",
            label = list(ARES_rec ~ "Hébergement avant l'entrée en MECS")) %>% 
  modify_header(label = " ") %>% 
  bold_labels() %>% 
  modify_spanning_header(c("stat_1", "stat_2","stat_3", "stat_4", "stat_5", "stat_6") ~ "**Hébergement à la sortie**") %>%
  as_hux_table() %>% 
  add_footnote("Source : ES-PE 2017.") %>%
  add_footnote("Champ : Sur les 15 777 enfants sortis de MECS au cours de 2017.") %>%
  set_number_format(NA) %>% 
  set_caption("Type d'hébergement avant l'entrée en MECS et juste à la sortie") 
```

## Modèles sur le type d'hébergement de sortie après être allé en MECS

```{r}
require(nnet)

mecs$MES_rec <- fct_recode(mecs$MES_rec,NULL = "NA")

modele <- mecs %>% select("age_ed", "SEX", "MES_rec", "SMES_rec","ARES_rec", "SRES_rec", "HEBE_rec3","MNA") %>% drop_na()

modele$SRES_rec <- fct_recode(modele$SRES_rec,
                              "Famille_assfam" = "Famille",
                              "Famille_assfam" = "Assfam",
                              "Logthors_autres" = "Logthors",
                              "Logthors_autres" = "Autres")
## Réordonnancement de modele$SRES_rec
modele$SRES_rec <- modele$SRES_rec %>%
  fct_relevel("EtabASEPJJ","Famille_assfam","Logthors_autres", "Logtacc")

modele$ARES_rec <- fct_recode(modele$ARES_rec,
                              "Famille_assfam" = "Famille",
                              "Famille_assfam" = "Assfam",
                              "Logthors_autres" = "Logthors",
                              "Logthors_autres" = "Autres")
## Réordonnancement de modele$SRES_rec
modele$ARES_rec <- modele$ARES_rec %>%
  fct_relevel("EtabASEPJJ","Logthors_autres", "Logtacc", "Famille_assfam")

## Réordonnancement de modele$HEBE_rec3
modele$HEBE_rec3 <- modele$HEBE_rec3 %>%
  fct_relevel("Collect","Autonomautre", "Assfam", "Domicile")

## Réordonnancement de modele$SEX
modele$SEX <- modele$SEX %>% fct_relevel("Homme", "Femme")

mod1 <- multinom(SRES_rec ~ age_ed + SEX + HEBE_rec3 + MNA, data = modele)

mod1 %>% tbl_regression(exponentiate = TRUE, 
                        label = list(age_ed ~ "Âge entrée en MECS",
                                     SEX ~ "Sexe",
                                     HEBE_rec3 ~ "Type d'hébergement en MECS")) %>% 
  add_significance_stars(hide_se = TRUE, hide_ci = TRUE) %>%
  modify_header(label = "**Référence : Collectif**") %>%
  modify_caption("Modèle 1 réduit : type d'hébergement à la sortie de MECS")  %>% 
  modify_column_hide("ci") %>% 
  bold_labels()%>%
  multinom_pivot_wider() %>% 
  as_hux_table() %>% 
  add_footnote("Source : ES-PE 2017.") %>%
  add_footnote("Champ : Sur les 10 983 enfants sortis au cours de 2017.") %>%
  set_number_format(NA)
```

Effet logique de l'âge qui voit plus de chance de sortir en logement hors ou acc à 16 et + , et surtout moins de chance avec l'âge de sortir en collectif ou en famille et sssfam par rapport au fait d'être en logement hors.

Effet de genre : biaisé, les femmes sont bien moins représentées dans la catégorie logthors.


```{r}
mod2 <- multinom(SRES_rec ~ age_ed + SEX + HEBE_rec3 + ARES_rec + MNA, data = modele)
mod2 %>% tbl_regression(exponentiate = TRUE, 
                        label = list(age_ed ~ "Âge entrée en MECS",
                                     SEX ~ "Sexe",
                                     HEBE_rec3 ~ "Type d'hébergement en MECS",
                                     ARES_rec ~ "Type d'hébergement avant MECS")) %>% 
  add_significance_stars(hide_se = TRUE, hide_ci = TRUE) %>%
  modify_header(label = "**Référence : Collectif**") %>%
  modify_caption("Modèle 2 complet : type d'hébergement à la sortie de MECS")  %>% 
  modify_column_hide("ci") %>% 
  bold_labels()%>%
  multinom_pivot_wider()%>% 
  as_hux_table() %>% 
  add_footnote("Source : ES-PE 2017.") %>%
  add_footnote("Champ : Sur les 10 983 enfants sortis au cours de 2017.") %>%
  set_number_format(NA)
```

```{r}
mod3 <- multinom(SRES_rec ~ age_ed + SEX + MNA + HEBE_rec3 + ARES_rec + ARES_rec*SEX, data = modele)
mod3 %>% tbl_regression(exponentiate = TRUE, 
                        label = list(age_ed ~ "Âge entrée en MECS",
                                     SEX ~ "Sexe",
                                     HEBE_rec3 ~ "Type d'hébergement en MECS",
                                     ARES_rec ~ "Type d'hébergement avant MECS")) %>% 
  add_significance_stars(hide_se = TRUE, hide_ci = TRUE) %>%
  modify_header(label = "**Référence : Collectif**") %>%
  modify_caption("Modèle 3 avec interaction : type d'hébergement à la sortie de MECS")  %>% 
  modify_column_hide("ci") %>% 
  bold_labels()%>%
  multinom_pivot_wider()%>% 
  as_hux_table() %>% 
  add_footnote("Source : ES-PE 2017.") %>%
  add_footnote("Champ : Sur les 10 983 enfants sortis au cours de 2017.") %>%
  set_number_format(NA)
```


```{r}
mod4 <- multinom(SRES_rec ~ age_ed + SEX + MNA + HEBE_rec3 + ARES_rec + HEBE_rec3*SEX + ARES_rec*SEX, data = modele)
mod4 %>% tbl_regression(exponentiate = TRUE, 
                        label = list(age_ed ~ "Âge entrée en MECS",
                                     SEX ~ "Sexe",
                                     HEBE_rec3 ~ "Type d'hébergement en MECS",
                                     ARES_rec ~ "Type d'hébergement avant MECS")) %>% 
  add_significance_stars(hide_se = TRUE, hide_ci = TRUE) %>%
  modify_header(label = "**Référence : Collectif**") %>%
  modify_caption("Modèle 4 avec interaction 2 : type d'hébergement à la sortie de MECS")  %>% 
  modify_column_hide("ci") %>% 
  bold_labels()%>%
  multinom_pivot_wider()%>% 
  as_hux_table() %>% 
  add_footnote("Source : ES-PE 2017.") %>%
  add_footnote("Champ : Sur les 10 983 enfants sortis au cours de 2017.") %>%
  set_number_format(NA)
```


## Annexes 

```{r}
t1 <- modele %>% tbl_cross(row = ARES_rec, col = SRES_rec)
t2 <- modele %>% tbl_cross(row = SEX, col = SRES_rec)
t3 <- modele %>% tbl_cross(row = age_ed, col = SRES_rec)
t4 <- modele %>% tbl_cross(row = HEBE_rec3, col = SRES_rec)
t5 <- modele %>% tbl_cross(row = MNA, col = SRES_rec)
tbl_stack(list(t1,t2,t3, t4, t5)) %>% 
  modify_caption("Tableau de vérification des effectifs en vue du modèle")%>% 
  as_hux_table() %>% 
  add_footnote("Source : ES-PE 2017.") %>%
  add_footnote("Champ : Sur les 10 983 enfants sortis au cours de 2017.") %>%
  set_number_format(NA)

test <- subset(modele, SEX == "Femme")
test %>% tbl_cross(row = ARES_rec, col = SRES_rec)

test <- subset(modele, SEX == "Homme")
test %>% tbl_cross(row = ARES_rec, col = SRES_rec)
```

## Modèles sur l'entrée de MECS

```{r}
enf$ARES_rec <- recode_res(enf$ARES)

enf$mecs <- case_when(enf$CATEG_rec == "MECS" ~ "En mecs",
                      T ~ "Pas en mecs")

modele <- enf %>% select("age_ed","age_ppd","SEX", "MES_rec","AMES_rec", "ARES_rec", "HEBE_rec3","MNA", "mecs", "HAND") %>% drop_na()

## Recodage de modele$mecs
modele$mecs <- modele$mecs %>%
  fct_recode("1" = "En mecs", "0" = "Pas en mecs")

## Réordonnancement de modele$ARES_rec
modele$ARES_rec <- modele$ARES_rec %>%
  fct_relevel("Autres",
              "EtabASEPJJ", "Famille", "Assfam", "Logtacc", "Logthors")

## Réordonnancement de modele$SEX
modele$SEX <- modele$SEX %>% fct_relevel("Homme", "Femme")
## Réordonnancement de modele$mecs
modele$mecs <- modele$mecs %>%
  fct_relevel(
    "0", "1")

m1 <- glm(mecs ~ age_ppd + age_ed + SEX + ARES_rec, data = modele, family = binomial(logit))

m1 %>% tbl_regression(exponentiate = TRUE) %>% 
  add_significance_stars(hide_se = TRUE, hide_ci = TRUE) %>%
  modify_header(label = "**Référence : Pas en MECS**") %>%
  modify_caption("Modèle 1 réduit : type d'hébergement à la sortie de MECS")  %>% 
  modify_column_hide("ci") %>% 
  bold_labels()%>%
  as_hux_table() %>% 
  add_footnote("Source : ES-PE 2017.") %>%
  add_footnote("Champ : Sur les 10 983 enfants sortis au cours de 2017.") %>%
  set_number_format(NA)

m2 <- glm(mecs ~ age_ed + SEX + ARES_rec + MNA + HAND, data = modele, family = binomial(logit))

m2 %>% tbl_regression(exponentiate = TRUE) %>% 
  add_significance_stars(hide_se = TRUE, hide_ci = TRUE) %>%
  modify_header(label = "**Référence : Pas en MECS**") %>%
  modify_caption("Modèle 2 MNA + HAND : type d'hébergement à la sortie de MECS")  %>% 
  modify_column_hide("ci") %>% 
  bold_labels()%>%
  as_hux_table() %>% 
  add_footnote("Source : ES-PE 2017.") %>%
  add_footnote("Champ : Sur les 10 983 enfants sortis au cours de 2017.") %>%
  set_number_format(NA)


m3 <- glm(mecs ~ age_ed + SEX + ARES_rec + MNA + HAND + ARES_rec*SEX, data = modele, family = binomial(logit))

m3 %>% tbl_regression(exponentiate = TRUE) %>% 
  add_significance_stars(hide_se = TRUE, hide_ci = TRUE) %>%
  modify_header(label = "**Référence : Pas en MECS**") %>%
  modify_caption("Modèle 3 interaction : type d'hébergement à la sortie de MECS")  %>% 
  modify_column_hide("ci") %>% 
  bold_labels()%>%
  as_hux_table() %>% 
  add_footnote("Source : ES-PE 2017.") %>%
  add_footnote("Champ : Sur les 10 983 enfants sortis au cours de 2017.") %>%
  set_number_format(NA)

m4 <- glm(mecs ~ age_ed + SEX + ARES_rec + MNA + HAND + ARES_rec*SEX + MNA*SEX, data = modele, family = binomial(logit))
```
## Annexes 

```{r}
t1 <- modele %>% tbl_cross(row = ARES_rec, col = mecs)
t2 <- modele %>% tbl_cross(row = SEX, col = mecs)
t3 <- modele %>% tbl_cross(row = age_ed, col = mecs)
t4 <- modele %>% tbl_cross(row = age_ppd, col = mecs)
t5 <- modele %>% tbl_cross(row = MNA, col = mecs)
tbl_stack(list(t1,t2,t3, t4, t5)) %>% 
  modify_caption("Tableau de vérification des effectifs en vue du modèle")%>% 
  as_hux_table() %>% 
  add_footnote("Source : ES-PE 2017.") %>%
  add_footnote("Champ : Sur les 10 983 enfants sortis au cours de 2017.") %>%
  set_number_format(NA)

test <- subset(modele, SEX == "Femme")
test %>% tbl_cross(row = ARES_rec, col = mecs)

test <- subset(modele, SEX == "Homme")
test %>% tbl_cross(row = ARES_rec, col = mecs)
```

